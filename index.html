<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Warden by dre1080</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/dre1080/warden">View On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/dre1080/warden/zipball/master">ZIP</a></li>
          <li class="downloads"><a href="https://github.com/dre1080/warden/tarball/master">TAR</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>Warden</h1>
          <p>More than just a user database auth package for FuelPHP</p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/dre1080">dre1080</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="http://twitter.com/#!/michigangraham">mattgraham</a></span>
        </div>

        <p>Warden is a user database auth package for the FuelPHP framework that aims to fast track development by handling the work load of authenticating and authorizing user's.
Built for performance, it comes with ready-to-use models and database install tasks.</p>

<h2>Features</h2>

<ul>
<li>Secure BCrypt password hashing and protection against brute force attacks.</li>
<li>User login/logout with "remember-me" functionality.</li>
<li>HTTP Authentication.</li>
<li>User ACL (roles / groups, and permissions).</li>
<li>User "friendships" and profiles.</li>
<li>Track information about user sign ins.</li>
<li>User account password resets.</li>
<li>User activation by email.</li>
<li>User account locking.</li>
<li>OAuth support.</li>
<li>And many more!</li>
</ul><h2>Why use BCrypt?</h2>

<ul>
<li><a href="http://codahale.com/how-to-safely-store-a-password">How To Safely Store A Password</a></li>
<li><a href="http://yorickpeterse.com/articles/use-bcrypt-fool">Use BCrypt Fool!</a></li>
<li><a href="http://phpmaster.com/why-you-should-use-bcrypt-to-hash-stored-passwords">Why You Should Use Bcrypt to Hash Stored Passwords</a></li>
<li><a href="http://chargen.matasano.com/chargen/2007/9/7/enough-with-the-rainbow-tables-what-you-need-to-know-about-s.html">Enough With The Rainbow Tables: What You Need To Know About Secure Password Schemes</a></li>
<li><a href="http://news.ycombinator.com/item?id=2004962">No. Use Bcrypt. Always</a></li>
</ul><h2>Installation</h2>

<h3>Dependencies</h3>

<p>Required Packages:</p>

<ul>
<li><a href="https://github.com/fuel/orm">Orm</a></li>
<li><a href="https://github.com/fuel/email">Email</a></li>
</ul><p>Optional:</p>

<ul>
<li>
<a href="https://github.com/philsturgeon/fuel-ninjauth">Fuel NinjAuth</a> for oAuth feature (use the Warden adapter).</li>
</ul><h3>Download</h3>

<p>This package follows standard installation rules.</p>

<p>Download Warden into your FuelPHP's packages directory.</p>

<p>Or</p>

<pre><code>git clone -b master https://github.com/dre1080/warden.git warden
</code></pre>

<p>Then autoload the package in your app/config.php file.</p>

<div class="highlight"><pre><span class="s1">'always_load'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
  <span class="s1">'packages'</span>  <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">'warden'</span><span class="p">)</span>
  <span class="p">),</span>
<span class="p">)</span>
</pre></div>

<p><strong>After adding warden to your fuelphp packages stack, have a look at the warden config file to setup
warden configs before adding the required tables.</strong></p>

<h3>Adding required tables to your database</h3>

<p>There are two ways to add the Warden tables:</p>

<p>1) SQL File in warden/config/install.sql</p>

<p>2) Oil Task</p>

<pre><code>php oil r warden help
</code></pre>

<p>To get a list of supported commands.</p>

<p><strong>Once done, don't forget to create your roles and permissions in the <em>roles</em> and <em>permissions</em> tables, respectively; in order to be able to assign roles and permissions to users.</strong></p>

<h2>Usage</h2>

<p>Check for validated login:</p>

<div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">Warden</span><span class="o">::</span><span class="na">check</span><span class="p">())</span> <span class="p">{</span>
  <span class="k">echo</span> <span class="s2">"I'm logged in :D"</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="k">echo</span> <span class="s2">"Failed, I'm NOT logged in :("</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>Getting the currently logged in user:</p>

<div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">Warden</span><span class="o">::</span><span class="na">check</span><span class="p">())</span> <span class="p">{</span>
  <span class="nv">$current_user</span> <span class="o">=</span> <span class="nx">Warden</span><span class="o">::</span><span class="na">current_user</span><span class="p">();</span>
  <span class="k">echo</span> <span class="nv">$current_user</span><span class="o">-&gt;</span><span class="na">username</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>Explicitly setting the current user:</p>

<div class="highlight"><pre><span class="k">if</span> <span class="p">((</span><span class="nv">$user</span> <span class="o">=</span> <span class="nx">Model_User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
  <span class="nx">Warden</span><span class="o">::</span><span class="na">set_user</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>Checking for a specific role:</p>

<div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">Warden</span><span class="o">::</span><span class="na">logged_in</span><span class="p">(</span><span class="s1">'admin'</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">echo</span> <span class="s2">"Current user logged in as an admin"</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$user</span> <span class="o">=</span> <span class="nx">Model_User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">Warden</span><span class="o">::</span><span class="na">has_access</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'editor'</span><span class="p">,</span> <span class="s1">'moderator'</span><span class="p">),</span> <span class="nv">$user</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">echo</span> <span class="s2">"Hey, editor - moderator"</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="k">echo</span> <span class="s2">"Fail!"</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>Checking the current user has permission for a resource:</p>

<div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">Warden</span><span class="o">::</span><span class="na">can</span><span class="p">(</span><span class="s1">'create'</span><span class="p">,</span> <span class="s1">'Article'</span><span class="p">))</span> <span class="p">{</span>
  <span class="c1">// do something</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">Response</span><span class="o">::</span><span class="na">redirect</span><span class="p">(</span><span class="s1">'/403'</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>or the inverse:</p>

<div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">Warden</span><span class="o">::</span><span class="na">cannot</span><span class="p">(</span><span class="s1">'create'</span><span class="p">,</span> <span class="s1">'Article'</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">Response</span><span class="o">::</span><span class="na">redirect</span><span class="p">(</span><span class="s1">'/403'</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>It also accepts array arguments to check for multiple permissions for actions/resources:</p>

<div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">Warden</span><span class="o">::</span><span class="na">can</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'destroy'</span><span class="p">,</span> <span class="s1">'create'</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="s1">'Project'</span><span class="p">,</span> <span class="s1">'Task'</span><span class="p">)))</span> <span class="p">{</span>
  <span class="c1">// do something</span>
<span class="p">}</span>
</pre></div>

<p>Or if you want to throw an exception, use <code>Warden::authorize</code>:</p>

<div class="highlight"><pre><span class="k">try</span> <span class="p">{</span>
  <span class="nx">Warden</span><span class="o">::</span><span class="na">authorize</span><span class="p">(</span><span class="s1">'create'</span><span class="p">,</span> <span class="s1">'Article'</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\Warden\AccessDenied</span> <span class="nv">$ex</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">die</span><span class="p">(</span><span class="nv">$ex</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>

<p>Log in a user by using a username or email and plain-text password:</p>

<div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">Input</span><span class="o">::</span><span class="na">method</span><span class="p">()</span> <span class="o">===</span> <span class="s1">'POST'</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">Warden</span><span class="o">::</span><span class="na">authenticate</span><span class="p">(</span><span class="nx">Input</span><span class="o">::</span><span class="na">post</span><span class="p">(</span><span class="s1">'username_or_email'</span><span class="p">),</span> <span class="nx">Input</span><span class="o">::</span><span class="na">post</span><span class="p">(</span><span class="s1">'password'</span><span class="p">)))</span> <span class="p">{</span>
    <span class="nx">Session</span><span class="o">::</span><span class="na">set_flash</span><span class="p">(</span><span class="s1">'success'</span><span class="p">,</span> <span class="s1">'Logged in successfully'</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">Session</span><span class="o">::</span><span class="na">set_flash</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="s1">'Username or password invalid'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">Response</span><span class="o">::</span><span class="na">redirect</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p>Log in a user using a http based authentication method:</p>

<div class="highlight"><pre><span class="k">if</span> <span class="p">((</span><span class="nv">$user_array</span> <span class="o">=</span> <span class="nx">Warden</span><span class="o">::</span><span class="na">http_authenticate</span><span class="p">()))</span> <span class="p">{</span>
  <span class="k">echo</span> <span class="s2">"Welcome </span><span class="si">{</span><span class="nv">$user_array</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>Log out a user by removing the related session variables:</p>

<div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">Warden</span><span class="o">::</span><span class="na">logout</span><span class="p">())</span> <span class="p">{</span>
  <span class="k">echo</span> <span class="s2">"I'm logged out"</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>Resetting a user's password</p>

<div class="highlight"><pre><span class="c1">// Sending the password token</span>
<span class="k">if</span> <span class="p">((</span><span class="nv">$user</span> <span class="o">=</span> <span class="nx">Model_User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="s1">'first'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'where'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="s1">'myemail@warden.net'</span><span class="p">)))))</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">send_reset_password_instructions</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$ex</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">'Oops, something went wrong: %s'</span><span class="p">,</span> <span class="nv">$ex</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Resetting the password</span>
<span class="k">try</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">((</span><span class="nv">$user</span> <span class="o">=</span> <span class="nx">Model_User</span><span class="o">::</span><span class="na">reset_password_by_token</span><span class="p">(</span><span class="nx">\Input</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">'reset_password_token'</span><span class="p">),</span> <span class="s1">'new_password'</span><span class="p">)))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">'Success!'</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">'Not a valid user'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$ex</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// something went wrong</span>
  <span class="k">echo</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">'Oops, something went wrong: %s'</span><span class="p">,</span> <span class="nv">$ex</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>

<h2>Callbacks</h2>

<p><code>after_set_user</code>, <code>after_authentication</code>, <code>before_logout</code>, <code>after_authorization</code></p>

<div class="highlight"><pre><span class="nx">Warden</span><span class="o">::</span><span class="na">before_logout</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">logger</span><span class="p">(</span><span class="nx">\Fuel</span><span class="o">::</span><span class="na">L_INFO</span><span class="p">,</span> <span class="s1">'User '</span><span class="o">.</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">id</span><span class="o">.</span><span class="s1">' logging out'</span><span class="p">,</span> <span class="s1">'Warden::before_logout'</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p><em>More examples are in the doc comments for each method.</em></p>

<h2>Fuel-Administrator</h2>

<p>For an example of how to use warden as an administrative interface to manage users, roles etc.
Please see <a href="https://github.com/webstone/fuel-administrator">Fuel-Administrator</a> by <a href="https://github.com/webstone" class="user-mention">@webstone</a></p>

<h2>Contributors</h2>

<p>Creator and lead developer: Andrew Wayne (<a href="http://twitter.com/__ando">ando</a>) <a href="https://github.com/dre1080" class="user-mention">@dre1080</a>.</p>

<p>Special thanks to: </p>

<ul>
<li><a href="https://github.com/craighooghiem" class="user-mention">@craighooghiem</a></li>
<li><a href="https://github.com/jesseobrien" class="user-mention">@jesseobrien</a></li>
<li>
<a href="https://github.com/Tenga" class="user-mention">@Tenga</a> </li>
<li><a href="https://github.com/rclanan" class="user-mention">@rclanan</a></li>
<li>
<a href="https://github.com/aranw" class="user-mention">@aranw</a> </li>
<li>
<a href="https://github.com/andreoav" class="user-mention">@andreoav</a> </li>
<li><a href="https://github.com/PrimozRome" class="user-mention">@PrimozRome</a></li>
<li><a href="https://github.com/webstone" class="user-mention">@webstone</a></li>
</ul><p>for contributing code, ideas and testing early versions.</p>

<p>Thanks also to the @fuel dev team + many who have contributed code, ideas and issues.</p>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-29590272-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>